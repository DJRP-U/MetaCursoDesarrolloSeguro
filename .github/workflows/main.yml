  zap-dast:
    name: OWASP ZAP (DAST)
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      issues: write

    env:
      ZAP_TARGET_URL: ${{ vars.ZAP_TARGET_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: Validate ZAP target
        run: |
          echo "ZAP_TARGET_URL=$ZAP_TARGET_URL"
          if [ -z "$ZAP_TARGET_URL" ]; then
            echo "ERROR: vars.ZAP_TARGET_URL está vacío"
            exit 1
          fi
          case "$ZAP_TARGET_URL" in
            http://*|https://*) ;;
            *) echo "ERROR: el target debe iniciar con http:// o https://"; exit 1 ;;
          esac

      - name: ZAP Full Scan (log en la salida del step)
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: ${{ env.ZAP_TARGET_URL }}
          artifact_name: zap_dast
          cmd_options: "-d -j"
